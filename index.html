<script>
async function sendToAI() {

    const fileInput = document.getElementById("xrayUpload");
    const file = fileInput.files[0];

    if (!file) {
        alert("Please upload an X-ray image first.");
        return;
    }

    document.getElementById("result").style.display = "block";
    document.getElementById("result").innerHTML = "Analyzing image... Please wait.";

    const formData = new FormData();
    formData.append("data", file);

    try {
        const response = await fetch(
            "https://syedasrar-syedz-ai-backend.hf.space/run/predict",
            {
                method: "POST",
                body: formData
            }
        );

        const result = await response.json();

        if (!result.data) {
            throw new Error("Invalid response from AI server");
        }

        const aiOutput = result.data[0];

        let formatted = "<b>AI Analysis Results:</b><br><br>";

        for (let key in aiOutput) {
            let value = aiOutput[key];
            let percent = (value * 100).toFixed(1);

            if (value > 0.6) {
                formatted += "<span style='color:red;font-weight:bold'>" + key + ": " + percent + "%</span><br>";
            } else {
                formatted += key + ": " + percent + "%<br>";
            }
        }

        document.getElementById("result").innerHTML = formatted;

    } catch (error) {
        document.getElementById("result").innerHTML =
            "<span style='color:red'>AI Server Error. Please try again.</span>";
    }
}


/* Generate AI from table button */
function runAI(btn, id, study) {

    const fileInput = document.getElementById("xrayUpload");

    if (!fileInput.files[0]) {
        alert("Please upload an X-ray image first from toolbar.");
        return;
    }

    sendToAI();

    // Update workflow
    let row = btn.parentElement.parentElement;
    row.cells[6].innerHTML = "<span class='reviewed'>Yes</span>";
    row.cells[7].innerHTML = "No";

    // Open printable AI report
    let win = window.open("", "_blank");

    win.document.write(`
    <html>
    <head>
    <title>AI Report</title>
    <style>
    body{font-family:Arial;padding:40px;}
    h2{color:#2f6fd6;}
    .section{margin:10px 0;}
    hr{margin:20px 0;}
    </style>
    </head>
    <body>

    <h2>SYEDZ AI-PACS REPORT</h2>

    <div class="section"><b>Patient ID:</b> ${id}</div>
    <div class="section"><b>Study:</b> ${study}</div>

    <hr>

    <div class="section"><b>AI Analysis:</b></div>
    <div class="section">See on-screen AI probability results.</div>

    <hr>

    <div class="section"><b>Reviewed by:</b> Syed Asrar</div>
    <div class="section"><b>Date:</b> ${new Date().toLocaleString()}</div>

    <script>
    window.print();
    <\/script>

    </body>
    </html>
    `);

    win.document.close();
}
</script>
